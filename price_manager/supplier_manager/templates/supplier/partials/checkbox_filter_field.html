{# checkbox_select_multiple_advanced.html #}
{% load crispy_forms_field %}
{% load crispy_forms_filters %}
{% load l10n %}

<div id="div_{{ field.auto_id }}"
     class="mb-3{% if field.errors %} has-error{% endif %}"
     data-checkbox-filter>

    {% if field.label %}
        <legend class="form-label fw-bold mb-2">
            {{ field.label }}
            {% if field.field.required %}
                <span class="text-danger">*</span>
            {% endif %}
        </legend>
    {% endif %}

    {% if field.help_text %}
        <p class="form-text text-muted mb-2">
            {{ field.help_text|safe }}
        </p>
    {% endif %}

    {% if field.field.choices %}
        <div class="input-group input-group-sm mb-2">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input
                type="search"
                class="form-control"
                placeholder="Быстрый поиск"
                data-checkbox-filter-search
            >
        </div>
    {% endif %}

    <div class="form-check-group border rounded p-2 bg-light-subtle" style="max-height: 260px; overflow: auto;">
        {% if field.field.choices %}
            {% for choice in field.field.choices %}
                <div class="form-check mb-2" data-checkbox-filter-item data-checkbox-filter-text="{{ choice.1|lower }}">
                    <input
                        type="checkbox"
                        name="{{ field.html_name }}"
                        value="{{ choice.0 }}"
                        id="{{ field.auto_id }}_{{ forloop.counter0 }}"
                        class="form-check-input{% if field.errors %} is-invalid{% endif %}"
                        {% if choice.0|stringformat:'' in field.value %}checked{% endif %}
                    >
                    <label class="form-check-label" for="{{ field.auto_id }}_{{ forloop.counter0 }}">
                        {{ choice.1 }}
                    </label>
                </div>
            {% endfor %}
        {% elif field.label %}
            <div>{{ field.label }} не найдены</div>
        {% else %}
            <div>Нет подходящих</div>
        {% endif %}
    </div>

    {% if field.errors %}
        <div class="invalid-feedback d-block">
            {% for error in field.errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
</div>

<script>
  const initCheckboxFilters = () => {
    const filterBlocks = document.querySelectorAll('[data-checkbox-filter]');
    filterBlocks.forEach((block) => {
      if (block.dataset.enhanced === 'true') {
        return;
      }

      const search = block.querySelector('[data-checkbox-filter-search]');
      const items = Array.from(block.querySelectorAll('[data-checkbox-filter-item]'));

      const applySearch = () => {
        if (!search) {
          return;
        }
        const term = search.value.trim().toLowerCase();
        items.forEach((item) => {
          const name = (item.dataset.checkboxFilterText || '').toLowerCase();
          item.classList.toggle('d-none', term && !name.includes(term));
        });
      };

      if (search) {
        search.addEventListener('input', applySearch);
      }

      applySearch();
      block.dataset.enhanced = 'true';
    });
  };

  document.addEventListener('DOMContentLoaded', initCheckboxFilters);
  document.body.addEventListener('htmx:afterSwap', initCheckboxFilters);
</script>