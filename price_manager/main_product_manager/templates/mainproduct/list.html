{% extends 'base.html' %}

{% block title %}
Главная страница
{% endblock %}


{% block style %}
  .main-filters-card {
    position: sticky;
    top: 88px;
    max-height: calc(100vh - 110px);
    overflow: auto;
  }
{% endblock %}

{% block body %}
  {% partialdef list inline %}
    <div id="mainproducts-block" class="row gap-2 p-4">
      
      <div class="col-3">
        <div class="main-filters-card">
        {% include "mainproduct/partials/filter.html" %}
        </div>
      </div>
      <div class="col-8">
        {% include 'mainproduct/partials/tables_bycat.html' %}
      </div>
    </div>
  {% endpartialdef %}
  <div id="modal-container" class="modal modal-xl fade" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
      <div class="modal-dialog">
          <div class="modal-content">
            <div class="container d-flex justify-content-center mb-4 mt-4">
              <div class="spinner-grow" role="status">
              </div>
              <div class="spinner-grow" role="status">
              </div>
              <div class="spinner-grow" role="status">
              </div>
            </div>
          </div>
      </div>
  </div>
{% endblock %}

{% block script %}
<script>
  const initCheckboxFilters = () => {
    const filterBlocks = document.querySelectorAll('[data-checkbox-filter]');
    filterBlocks.forEach((block) => {
      if (block.dataset.enhanced === 'true') {
        return;
      }

      const search = block.querySelector('[data-checkbox-filter-search]');
      const items = Array.from(block.querySelectorAll('[data-checkbox-filter-item]'));
      const selectAllButton = block.querySelector('[data-checkbox-filter-select-all]');
      const clearButton = block.querySelector('[data-checkbox-filter-clear]');
      const counter = block.querySelector('[data-selected-counter]');

      const updateCounter = () => {
        if (!counter) {
          return;
        }
        const checked = block.querySelectorAll('input[type="checkbox"]:checked').length;
        counter.textContent = `Выбрано: ${checked}`;
      };

      const applySearch = () => {
        if (!search) {
          return;
        }
        const term = search.value.trim().toLowerCase();
        items.forEach((item) => {
          const name = (item.dataset.checkboxFilterText || '').toLowerCase();
          item.classList.toggle('d-none', term && !name.includes(term));
        });
      };

      if (search) {
        search.addEventListener('input', applySearch);
      }

      if (selectAllButton) {
        selectAllButton.addEventListener('click', () => {
          items.forEach((item) => {
            if (item.classList.contains('d-none')) {
              return;
            }
            const checkbox = item.querySelector('input[type="checkbox"]');
            if (checkbox) {
              checkbox.checked = true;
              checkbox.dispatchEvent(new Event('change', { bubbles: true }));
            }
          });
          updateCounter();
        });
      }

      if (clearButton) {
        clearButton.addEventListener('click', () => {
          block.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
            checkbox.checked = false;
            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
          });
          updateCounter();
        });
      }

      block.addEventListener('change', (event) => {
        if (event.target && event.target.matches('input[type="checkbox"]')) {
          updateCounter();
        }
      });

      applySearch();
      updateCounter();
      block.dataset.enhanced = 'true';
    });
  };

  document.addEventListener('DOMContentLoaded', initCheckboxFilters);
  document.body.addEventListener('htmx:afterSwap', initCheckboxFilters);
</script>
{% endblock %}
