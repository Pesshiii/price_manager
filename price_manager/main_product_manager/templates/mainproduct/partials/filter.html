<div class="card p-3 shadow-sm border-0">
  {% partialdef filter inline %}
    <form
      id="mainproduct-filter"
      method="get"
      hx-get="{% url 'mainproducts' %}"
      hx-target="#mainproducts-block"
      hx-swap="outerHTML"
      hx-trigger="change, submit"
      class="d-flex flex-column gap-3"
    >
      <div class="filter-section" data-suggest-filter="supplier">
        <div class="filter-section-title">Поставщики</div>
        <label for="supplier-search-input" class="form-label small text-muted mb-1">Поиск с подсказками</label>
        <input
          type="search"
          id="supplier-search-input"
          class="form-control"
          placeholder="Начните вводить название поставщика..."
          list="supplier-search-options"
          autocomplete="off"
          data-suggest-input="supplier"
        >
        <datalist id="supplier-search-options">
          {% for checkbox in filter.form.supplier %}
            <option value="{{ checkbox.choice_label }}"></option>
          {% endfor %}
        </datalist>

        <div class="suggestion-list mt-2" data-suggest-list="supplier">
          {% for checkbox in filter.form.supplier %}
            <button type="button" class="suggestion-item" data-option-label="{{ checkbox.choice_label|lower }}" data-option-value="{{ checkbox.data.value }}" data-suggest-option="supplier">
              {{ checkbox.choice_label }}
            </button>
          {% empty %}
            <div class="small text-muted">Нет доступных поставщиков</div>
          {% endfor %}
        </div>

        <div class="selected-chips mt-2" data-selected-chips="supplier"></div>

        <div class="d-none" data-checkbox-container="supplier">
          {% for checkbox in filter.form.supplier %}
            {{ checkbox.tag }}
          {% endfor %}
        </div>
      </div>

      <div class="filter-section" data-suggest-filter="manufacturer">
        <div class="filter-section-title">Производители</div>
        <label for="manufacturer-search-input" class="form-label small text-muted mb-1">Поиск с подсказками</label>
        <input
          type="search"
          id="manufacturer-search-input"
          class="form-control"
          placeholder="Начните вводить название производителя..."
          list="manufacturer-search-options"
          autocomplete="off"
          data-suggest-input="manufacturer"
        >
        <datalist id="manufacturer-search-options">
          {% for checkbox in filter.form.manufacturer %}
            <option value="{{ checkbox.choice_label }}"></option>
          {% endfor %}
        </datalist>

        <div class="suggestion-list mt-2" data-suggest-list="manufacturer">
          {% for checkbox in filter.form.manufacturer %}
            <button type="button" class="suggestion-item" data-option-label="{{ checkbox.choice_label|lower }}" data-option-value="{{ checkbox.data.value }}" data-suggest-option="manufacturer">
              {{ checkbox.choice_label }}
            </button>
          {% empty %}
            <div class="small text-muted">Нет доступных производителей</div>
          {% endfor %}
        </div>

        <div class="selected-chips mt-2" data-selected-chips="manufacturer"></div>

        <div class="d-none" data-checkbox-container="manufacturer">
          {% for checkbox in filter.form.manufacturer %}
            {{ checkbox.tag }}
          {% endfor %}
        </div>
      </div>

      <div class="filter-section" data-suggest-filter="category">
        <div class="filter-section-title">Категории</div>
        <label for="category-search-input" class="form-label small text-muted mb-1">Поиск с подсказками</label>
        <input
          type="search"
          id="category-search-input"
          class="form-control"
          placeholder="Начните вводить название категории..."
          list="category-search-options"
          autocomplete="off"
          data-suggest-input="category"
        >
        <datalist id="category-search-options">
          {% for checkbox in filter.form.category %}
            <option value="{{ checkbox.choice_label }}"></option>
          {% endfor %}
        </datalist>

        <div class="suggestion-list mt-2" data-suggest-list="category">
          {% for checkbox in filter.form.category %}
            <button type="button" class="suggestion-item" data-option-label="{{ checkbox.choice_label|lower }}" data-option-value="{{ checkbox.data.value }}" data-suggest-option="category">
              {{ checkbox.choice_label }}
            </button>
          {% empty %}
            <div class="small text-muted">Нет доступных категорий</div>
          {% endfor %}
        </div>

        <div class="selected-chips mt-2" data-selected-chips="category"></div>

        <div class="d-none" data-checkbox-container="category">
          {% for checkbox in filter.form.category %}
            {{ checkbox.tag }}
          {% endfor %}
        </div>
      </div>

      <div class="d-flex gap-2 mt-1">
        <button type="submit" class="btn btn-primary flex-grow-1">Применить</button>
        <a href="{% url 'mainproducts' %}" class="btn btn-light border">Сброс</a>
      </div>
    </form>
  {% endpartialdef %}
</div>

<style>
  #mainproduct-filter .form-control {
    border-radius: .65rem;
  }

  .filter-section {
    border: 1px solid #eceff3;
    border-radius: .75rem;
    padding: .65rem;
    background: #fcfdff;
  }

  .filter-section-title {
    font-weight: 600;
    margin-bottom: .35rem;
  }

  .suggestion-list {
    display: flex;
    flex-direction: column;
    gap: .35rem;
    max-height: 190px;
    overflow: auto;
  }

  .suggestion-item {
    border: 1px solid #dbe2ea;
    border-radius: .5rem;
    background: #f9fbff;
    text-align: left;
    padding: .45rem .6rem;
    font-size: .92rem;
  }

  .suggestion-item:hover {
    background: #eef4ff;
  }

  .selected-chips {
    display: flex;
    flex-wrap: wrap;
    gap: .4rem;
  }

  .selected-chip {
    display: inline-flex;
    align-items: center;
    gap: .35rem;
    border: 1px solid #cfe1ff;
    background: #eaf3ff;
    color: #1f3f7a;
    border-radius: 999px;
    padding: .2rem .6rem;
    font-size: .82rem;
  }

  .selected-chip button {
    border: 0;
    background: transparent;
    padding: 0;
    line-height: 1;
    font-size: .95rem;
    color: #1f3f7a;
  }
</style>

<script>
  (() => {
    const initSuggestFilter = () => {
      const form = document.getElementById('mainproduct-filter');
      if (!form) {
        return;
      }

      const setupScope = (scope) => {
        const input = form.querySelector(`[data-suggest-input="${scope}"]`);
        const list = form.querySelector(`[data-suggest-list="${scope}"]`);
        const chips = form.querySelector(`[data-selected-chips="${scope}"]`);
        const checkboxContainer = form.querySelector(`[data-checkbox-container="${scope}"]`);

        if (!input || !list || !chips || !checkboxContainer) {
          return;
        }

        const getCheckboxByValue = (value) => checkboxContainer.querySelector(`input[type="checkbox"][value="${value}"]`);

        const renderChips = () => {
          const selected = Array.from(checkboxContainer.querySelectorAll('input[type="checkbox"]:checked'));
          chips.innerHTML = selected.map((inputEl) => {
            const option = list.querySelector(`[data-option-value="${inputEl.value}"]`);
            const label = (option?.textContent || inputEl.value).trim();
            return `<span class="selected-chip" data-chip-value="${inputEl.value}">${label}<button type="button" data-remove-chip="${scope}" data-remove-value="${inputEl.value}">×</button></span>`;
          }).join('');
        };

        const applySearch = () => {
          const term = (input.value || '').trim().toLowerCase();
          list.querySelectorAll('[data-suggest-option]').forEach((btn) => {
            const text = btn.dataset.optionLabel || '';
            btn.classList.toggle('d-none', Boolean(term) && !text.includes(term));
          });
        };

        if (input.dataset.bound !== 'true') {
          input.addEventListener('input', applySearch);
          input.addEventListener('change', applySearch);
          input.dataset.bound = 'true';
        }

        if (list.dataset.bound !== 'true') {
          list.addEventListener('click', (event) => {
            const option = event.target.closest('[data-suggest-option]');
            if (!option) {
              return;
            }
            const checkbox = getCheckboxByValue(option.dataset.optionValue);
            if (!checkbox) {
              return;
            }
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
            renderChips();
          });
          list.dataset.bound = 'true';
        }

        if (chips.dataset.bound !== 'true') {
          chips.addEventListener('click', (event) => {
            const button = event.target.closest(`[data-remove-chip="${scope}"]`);
            if (!button) {
              return;
            }
            const checkbox = getCheckboxByValue(button.dataset.removeValue);
            if (!checkbox) {
              return;
            }
            checkbox.checked = false;
            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
            renderChips();
          });
          chips.dataset.bound = 'true';
        }

        renderChips();
        applySearch();
      };

      ['supplier', 'manufacturer', 'category'].forEach(setupScope);
    };

    document.addEventListener('DOMContentLoaded', initSuggestFilter);
    document.body.addEventListener('htmx:afterSwap', (event) => {
      if (event.target && event.target.id === 'mainproducts-block') {
        initSuggestFilter();
      }
    });
  })();
</script>
