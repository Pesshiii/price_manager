<div class="card p-3 shadow-sm border-0">
  {% partialdef filter inline %}
    <form
      id="mainproduct-filter"
      method="get"
      hx-get="{% url 'mainproducts' %}"
      hx-target="#mainproducts-block"
      hx-swap="outerHTML"
      hx-trigger="change, submit"
      class="d-flex flex-column gap-3"
    >
      <div class="filter-section" data-tile-filter-section="supplier">
        <div class="filter-section-title">Поставщики</div>
        <label for="{{ filter.form.supplier_search.id_for_label }}" class="form-label small text-muted mb-1">Поиск поставщика</label>
        <input
          type="search"
          name="supplier_search"
          id="{{ filter.form.supplier_search.id_for_label }}"
          class="form-control"
          placeholder="Начните вводить..."
          value="{{ filter.form.supplier_search.value|default_if_none:'' }}"
          list="supplier-search-options"
          data-tile-filter-search="supplier"
          autocomplete="off"
        >
        <datalist id="supplier-search-options">
          {% for checkbox in filter.form.supplier %}
            <option value="{{ checkbox.choice_label }}"></option>
          {% endfor %}
        </datalist>
        <div class="d-flex justify-content-end mt-2 mb-2">
          <button type="button" class="btn btn-sm btn-outline-secondary" data-expand-tile-list="supplier-tiles">Ещё</button>
        </div>
        <div id="supplier-tiles" class="filter-tiles" data-tile-list="supplier">
          {% for checkbox in filter.form.supplier %}
            <label class="filter-tile" data-tile-text="{{ checkbox.choice_label|lower }}">
              {{ checkbox.tag }}
              <span>{{ checkbox.choice_label }}</span>
            </label>
          {% empty %}
            <div class="small text-muted">Нет доступных поставщиков</div>
          {% endfor %}
        </div>
      </div>

      <div class="filter-section" data-tile-filter-section="manufacturer">
        <div class="filter-section-title">Производители</div>
        <label for="{{ filter.form.manufacturer_search.id_for_label }}" class="form-label small text-muted mb-1">Поиск производителя</label>
        <input
          type="search"
          name="manufacturer_search"
          id="{{ filter.form.manufacturer_search.id_for_label }}"
          class="form-control"
          placeholder="Начните вводить..."
          value="{{ filter.form.manufacturer_search.value|default_if_none:'' }}"
          list="manufacturer-search-options"
          data-tile-filter-search="manufacturer"
          autocomplete="off"
        >
        <datalist id="manufacturer-search-options">
          {% for checkbox in filter.form.manufacturer %}
            <option value="{{ checkbox.choice_label }}"></option>
          {% endfor %}
        </datalist>
        <div class="d-flex justify-content-end mt-2 mb-2">
          <button type="button" class="btn btn-sm btn-outline-secondary" data-expand-tile-list="manufacturer-tiles">Ещё</button>
        </div>
        <div id="manufacturer-tiles" class="filter-tiles" data-tile-list="manufacturer">
          {% for checkbox in filter.form.manufacturer %}
            <label class="filter-tile" data-tile-text="{{ checkbox.choice_label|lower }}">
              {{ checkbox.tag }}
              <span>{{ checkbox.choice_label }}</span>
            </label>
          {% empty %}
            <div class="small text-muted">Нет доступных производителей</div>
          {% endfor %}
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-section-title">Категории</div>
        <label for="category-filter-search" class="form-label small text-muted mb-1">Поиск по категориям</label>
        <input type="search" class="form-control" id="category-filter-search" placeholder="Начните вводить название категории..." data-category-filter-search>

        <div class="category-filter-card mt-2" data-category-filter-tree>
          {% include 'supplier/partials/category_filter_field.html' with field=filter.form.category %}
        </div>
      </div>

      <div class="d-flex gap-2 mt-1">
        <button type="submit" class="btn btn-primary flex-grow-1">Применить</button>
        <a href="{% url 'mainproducts' %}" class="btn btn-light border">Сброс</a>
      </div>
    </form>
  {% endpartialdef %}
</div>

<style>
  #mainproduct-filter .form-control {
    border-radius: .65rem;
  }

  .filter-section {
    border: 1px solid #eceff3;
    border-radius: .75rem;
    padding: .65rem;
    background: #fcfdff;
  }

  .filter-section-title {
    font-weight: 600;
    margin-bottom: .35rem;
  }

  .filter-tiles {
    display: grid;
    grid-template-columns: repeat(1, minmax(0, 1fr));
    gap: .4rem;
    max-height: 102px;
    overflow: hidden;
    transition: max-height .2s ease;
  }

  .filter-tiles.filter-tiles--expanded {
    max-height: 340px;
    overflow: auto;
    padding-right: .25rem;
  }

  .filter-tile {
    display: flex;
    align-items: center;
    gap: .5rem;
    border: 1px solid #dbe2ea;
    border-radius: .45rem;
    padding: .42rem .55rem;
    font-size: .92rem;
    line-height: 1.25;
    background: #f7f9fc;
    cursor: pointer;
    user-select: none;
    box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.03);
  }

  .filter-tile.filter-tile--active {
    border-color: #86b7fe;
    background: #eaf3ff;
  }

  .filter-tile input {
    margin-top: 0;
    flex: 0 0 auto;
  }

  .category-filter-card {
    max-height: 280px;
    overflow: auto;
    border: 1px solid #eceff3;
    border-radius: .7rem;
    background: #fcfcfd;
    padding: .5rem .6rem;
  }

  .category-filter-card ul {
    list-style: none;
    padding-left: .8rem;
    margin-bottom: 0;
  }

  .category-filter-card > ul {
    padding-left: .2rem;
  }

  .category-filter-card label {
    font-size: .92rem;
  }
</style>

<script>
  (() => {
    const initFilterTiles = () => {
      document.querySelectorAll('[data-expand-tile-list]').forEach((button) => {
        if (button.dataset.bound === 'true') {
          return;
        }

        button.addEventListener('click', () => {
          const targetId = button.getAttribute('data-expand-tile-list');
          const list = document.getElementById(targetId);
          if (!list) {
            return;
          }
          list.classList.toggle('filter-tiles--expanded');
          button.textContent = list.classList.contains('filter-tiles--expanded') ? 'Свернуть' : 'Ещё';
        });

        button.dataset.bound = 'true';
      });
    };

    const syncActiveTileStyles = () => {
      document.querySelectorAll('.filter-tile').forEach((tile) => {
        const checkbox = tile.querySelector('input[type="checkbox"]');
        if (!checkbox) {
          return;
        }
        tile.classList.toggle('filter-tile--active', checkbox.checked);
      });
    };

    const initTileSearch = () => {
      document.querySelectorAll('[data-tile-filter-search]').forEach((input) => {
        if (input.dataset.bound === 'true') {
          return;
        }

        const key = input.dataset.tileFilterSearch;
        const tileList = document.querySelector(`[data-tile-list="${key}"]`);
        if (!tileList) {
          return;
        }

        const applySearch = () => {
          const term = (input.value || '').trim().toLowerCase();
          tileList.querySelectorAll('.filter-tile').forEach((tile) => {
            const text = tile.dataset.tileText || '';
            tile.classList.toggle('d-none', Boolean(term) && !text.includes(term));
          });
        };

        input.addEventListener('input', applySearch);
        applySearch();
        input.dataset.bound = 'true';
      });
    };

    const initCategoryQuickSearch = () => {
      const searchInput = document.querySelector('[data-category-filter-search]');
      const categoryTree = document.querySelector('[data-category-filter-tree]');

      if (!searchInput || !categoryTree || searchInput.dataset.bound === 'true') {
        return;
      }

      const normalize = (value) => (value || '').toLowerCase().trim();
      const labels = Array.from(categoryTree.querySelectorAll('label'));

      searchInput.addEventListener('input', () => {
        const term = normalize(searchInput.value);
        labels.forEach((label) => {
          const wrapper = label.closest('.form-check, .accordion-item');
          if (!wrapper) {
            return;
          }
          const text = normalize(label.textContent);
          const show = !term || text.includes(term);
          wrapper.classList.toggle('d-none', !show);
        });
      });

      searchInput.dataset.bound = 'true';
    };

    const initMainFilterUi = () => {
      initFilterTiles();
      initTileSearch();
      initCategoryQuickSearch();
      syncActiveTileStyles();
    };

    document.addEventListener('change', (event) => {
      if (event.target && event.target.matches('.filter-tile input[type="checkbox"]')) {
        syncActiveTileStyles();
      }
    });

    document.addEventListener('DOMContentLoaded', initMainFilterUi);
    document.body.addEventListener('htmx:afterSwap', (event) => {
      if (event.target && event.target.id === 'mainproducts-block') {
        initMainFilterUi();
      }
    });
  })();
</script>
