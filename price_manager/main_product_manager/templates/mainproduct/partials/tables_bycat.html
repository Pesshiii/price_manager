{% load export_url from django_tables2 %}

<div id="mainproducts-table" class="mb-5">
  <div class="row align-items-start">
    <h1 class="mb-4 col-8">Главный прайс</h1>
    <div class="col-4 mb-3 d-flex justify-content-end gap-2">
      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle"
                type="button"
                data-bs-toggle="dropdown"
                data-bs-auto-close="outside"
                aria-expanded="false">
          Столбцы
        </button>
        <div class="dropdown-menu dropdown-menu-end p-3" style="min-width: 360px; max-height: 55vh; overflow-y: auto;">
          <form hx-get="{% url 'mainproducts' %}"
                hx-target="#mainproducts-block"
                hx-swap="outerHTML"
                hx-trigger="change from:input[name='columns']">
            {% for key, values in request.GET.lists %}
              {% if key != 'columns' and key != 'page' %}
                {% for value in values %}
                  <input type="hidden" name="{{ key }}" value="{{ value }}">
                {% endfor %}
              {% endif %}
            {% endfor %}

            {% for group_label, group_choices in column_groups %}
              <div class="mb-2 {% if not forloop.last %}border-bottom pb-2{% endif %}">
                <div class="small fw-semibold text-muted mb-1">{{ group_label }}</div>
                {% for value, label in group_choices %}
                  <div class="form-check">
                    <input class="form-check-input"
                           type="checkbox"
                           value="{{ value }}"
                           name="columns"
                           id="columns_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}"
                           {% if value in selected_columns %}checked{% endif %}>
                    <label class="form-check-label small" for="columns_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}">
                      {{ label }}
                    </label>
                  </div>
                {% endfor %}
              </div>
            {% endfor %}
          </form>
        </div>
      </div>
      <button type="button"
              class="btn btn-primary"
              title="Обновить"
              data-bs-toggle="modal"
              data-bs-target="#modal-container"
              hx-get="{% url 'mainproducts-sync'%}"
              hx-target="#modal-container .modal-content"
              hx-swap="innerHTML">
        Обновить
      </button>
    </div>
  </div>
  {% if categories or has_nulled %}
    {% if has_nulled %}
        <div class="p-3 shadow-sm overflow-auto border rounded">
          <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <h2 class="h5 mb-0">
              Без категории
            </h2>
            <span class="badge text-bg-light">
              {{ nulled_mp_count}}
            </span>
          </div>
          <div
          hx-get="{% url "mainproduct-table-nocat"%}{% querystring%}"
          hx-trigger="load"
          hx-swap="outerHTML">
              <span class="placeholder col-12 placeholder-lg bg-light">
              </span>
              <span class="placeholder col-12 placeholder-lg bg-light">
              </span>
              <span class="placeholder col-12 placeholder-lg bg-light">
              </span>
          </div>
        </div>
    {% endif %}
    {% partialdef category-table inline=True%}
      {% for category in categories %}
        {% if forloop.last and categories.has_next %}
          <div 
            hx-get="{% url "mainproducts" %}{% querystring page=categories.next_page_number %}"
            hx-trigger="revealed"
            hx-swap="afterend"
            hx-indicator="#spinner"
            class="p-3 shadow-sm overflow-auto mt-4 border rounded">
        {% else %}
          <div class="p-3 shadow-sm overflow-auto mt-4 border rounded">
        {% endif %} 
          {% if category %}
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
              <h2 class="h5 mb-0">
                {{ category.name|default:"" }}
              </h2>
              <span class="badge text-bg-light">
                {{ category.mps_count}}
              </span>
            </div>
            <div 
            hx-get="{% url "mainproduct-table-bycat" category_pk=category.pk %}{% querystring %}"
            hx-trigger="load"
            hx-swap="outerHTML">
              <span class="placeholder col-12 placeholder-lg bg-light">
              </span>
              <span class="placeholder col-12 placeholder-lg bg-light">
              </span>
              <span class="placeholder col-12 placeholder-lg bg-light">
              </span>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% endpartialdef %}
  {% else %}
    <div class="alert alert-info mb-0">
      Товары не найдены.
    </div>
  {% endif %}
</div>

<div  id="spinner" class="text-center htmx-indicator">
  <div class="spinner-grow" style="width: 2rem; height: 2rem;" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <div class="spinner-grow" style="width: 2rem; height: 2rem;" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <div class="spinner-grow" style="width: 2rem; height: 2rem;" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>
