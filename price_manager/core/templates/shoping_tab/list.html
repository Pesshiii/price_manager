{% extends 'base.html' %}
{% load special_tags %}

{% block title %}Корзины{% endblock %}

{% block body %}
<div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-3 mb-4">
  <h1 class="h3 mb-0">Корзины</h1>
  <a class="btn btn-outline-secondary" href="{% url 'main' %}"><i class="bi bi-arrow-left"></i> Вернуться к прайсу</a>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h2 class="h5 mb-3">Создать новую корзину</h2>
    <form method="post" class="row g-3 align-items-end">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_tab">
      <div class="col-lg-6">
        <label class="form-label" for="{{ tab_form.name.id_for_label }}">Название корзины</label>
        {{ tab_form.name }}
        {% if tab_form.name.errors %}
          <div class="invalid-feedback d-block">
            {% for error in tab_form.name.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
      <div class="col-lg-auto">
        <button type="submit" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Создать</button>
      </div>
    </form>
  </div>
</div>

{% if not tabs %}
  <div class="alert alert-info">Корзины ещё не созданы. Используйте форму выше, чтобы добавить первую корзину.</div>
{% endif %}

{% for tab in tabs %}
  {% with products=tab.products.all %}
  <div class="card shadow-sm mb-4" id="tab-{{ tab.id }}">
    <div class="card-header d-flex flex-column flex-lg-row justify-content-lg-between align-items-lg-center gap-2">
      <div>
        <h2 class="h5 mb-1">{{ tab.name }}</h2>
        <span class="text-muted">{{ products|length }} товар(ов)</span>
      </div>
      <form method="post" action="{% url 'shoping-tab-delete' tab.id %}" class="ms-lg-auto" onsubmit="return confirm('Удалить корзину «{{ tab.name }}»?');">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-danger btn-sm">
          <i class="bi bi-trash"></i> Удалить корзину
        </button>
      </form>
    </div>
    <div class="card-body">
      {% if products %}
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>Название</th>
                <th>Главный товар</th>
                <th class="text-end">Действия</th>
              </tr>
            </thead>
            <tbody>
              {% for product in products %}
                <tr>
                  <td>{{ product.name }}</td>
                  <td>
                    {% if product.main_product %}
                      <a href="{% url 'main-product-update' product.main_product_id %}" class="link-primary">{{ product.main_product.name }}</a>
                    {% else %}
                      <span class="text-muted">Не привязан</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <a href="{% url 'shoping-tab-product-edit' tab.id product.id %}" class="btn btn-sm btn-outline-primary me-1">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <form method="post" action="{% url 'shoping-tab-product-remove' tab.id product.id %}" class="d-inline" onsubmit="return confirm('Удалить товар из корзины?');">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-x"></i>
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted">В корзине пока нет товаров.</p>
      {% endif %}

      <div class="border-top pt-3 mt-4">
        <h3 class="h6">Добавить товар вручную</h3>
        {% with add_form=product_forms|get_item:tab.id %}
        <form method="post" class="row g-3 align-items-end">
          {% csrf_token %}
          <input type="hidden" name="action" value="add_product">
          <input type="hidden" name="tab_id" value="{{ tab.id }}">
          <div class="col-md-4">
            <label class="form-label" for="{{ add_form.name.id_for_label }}">Название</label>
            {{ add_form.name }}
            {% if add_form.name.errors %}
              <div class="invalid-feedback d-block">
                {% for error in add_form.name.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
              </div>
            {% endif %}
          </div>
          <div class="col-md-5">
            <label class="form-label" for="{{ add_form.main_product.id_for_label }}">Связанный товар</label>
            {{ add_form.main_product }}
            {% if add_form.main_product.errors %}
              <div class="invalid-feedback d-block">
                {% for error in add_form.main_product.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
              </div>
            {% endif %}
          </div>
          <div class="col-md-auto">
            <button type="submit" class="btn btn-success"><i class="bi bi-cart-plus"></i> Добавить</button>
          </div>
        </form>
        {% endwith %}
      </div>
    </div>
  </div>
  {% endwith %}
{% endfor %}
{% endblock %}
