{% load export_url from django_tables2 %}
{% load django_tables2 %}

<div id="main-table-container" class="table-area mb-5">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-4">
    <h1 class="mb-0">Главный прайс</h1>
    <div class="dropdown">
      <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        Столбцы
      </button>
      <div class="dropdown-menu dropdown-menu-end p-3 main-columns-menu">
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="actions" id="main-col-actions" checked>
          <label class="form-check-label" for="main-col-actions">Действия</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="sku" id="main-col-sku" checked>
          <label class="form-check-label" for="main-col-sku">SKU</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="article" id="main-col-article" checked>
          <label class="form-check-label" for="main-col-article">Артикул</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="supplier" id="main-col-supplier" checked>
          <label class="form-check-label" for="main-col-supplier">Поставщик</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="name" id="main-col-name" checked>
          <label class="form-check-label" for="main-col-name">Название</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="category" id="main-col-category" checked>
          <label class="form-check-label" for="main-col-category">Категория</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="manufacturer" id="main-col-manufacturer" checked>
          <label class="form-check-label" for="main-col-manufacturer">Производитель</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="stock" id="main-col-stock" checked>
          <label class="form-check-label" for="main-col-stock">Остаток</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="weight" id="main-col-weight" checked>
          <label class="form-check-label" for="main-col-weight">Вес</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="prime_cost" id="main-col-prime-cost" checked>
          <label class="form-check-label" for="main-col-prime-cost">Себестоимость</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="wholesale_price" id="main-col-wholesale-price" checked>
          <label class="form-check-label" for="main-col-wholesale-price">Оптовая цена</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="basic_price" id="main-col-basic-price" checked>
          <label class="form-check-label" for="main-col-basic-price">Базовая цена</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="m_price" id="main-col-m-price" checked>
          <label class="form-check-label" for="main-col-m-price">Цена ИМ</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="wholesale_price_extra" id="main-col-wholesale-price-extra" checked>
          <label class="form-check-label" for="main-col-wholesale-price-extra">Оптовая цена доп.</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="length" id="main-col-length" checked>
          <label class="form-check-label" for="main-col-length">Длина</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="width" id="main-col-width" checked>
          <label class="form-check-label" for="main-col-width">Ширина</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="depth" id="main-col-depth" checked>
          <label class="form-check-label" for="main-col-depth">Глубина</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="price_updated_at" id="main-col-price-updated-at" checked>
          <label class="form-check-label" for="main-col-price-updated-at">Обновление цены</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="stock_updated_at" id="main-col-stock-updated-at" checked>
          <label class="form-check-label" for="main-col-stock-updated-at">Обновление остатков</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="price_managers" id="main-col-price-managers" checked>
          <label class="form-check-label" for="main-col-price-managers">Наценки</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="special_prices" id="main-col-special-prices" checked>
          <label class="form-check-label" for="main-col-special-prices">Спец наценки</label>
        </div>
        <hr class="my-2">
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="supplier_delivery_days" id="main-col-supplier-delivery-days" checked>
          <label class="form-check-label" for="main-col-supplier-delivery-days">Срок поставки (дней)</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="supplier_price_update_rate" id="main-col-supplier-price-update-rate" checked>
          <label class="form-check-label" for="main-col-supplier-price-update-rate">Частота обновления цен (поставщик)</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="supplier_stock_update_rate" id="main-col-supplier-stock-update-rate" checked>
          <label class="form-check-label" for="main-col-supplier-stock-update-rate">Частота обновления остатков (поставщик)</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="supplier_currency" id="main-col-supplier-currency" checked>
          <label class="form-check-label" for="main-col-supplier-currency">Валюта поставщика</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="supplier_price_updated_at" id="main-col-supplier-price-updated-at" checked>
          <label class="form-check-label" for="main-col-supplier-price-updated-at">Обновление цены поставщика</label>
        </div>
        <div class="form-check">
          <input class="form-check-input main-column-toggle" type="checkbox" value="supplier_stock_updated_at" id="main-col-supplier-stock-updated-at" checked>
          <label class="form-check-label" for="main-col-supplier-stock-updated-at">Обновление остатков поставщика</label>
        </div>
        <div class="mt-2">
          <button class="btn btn-link btn-sm p-0 text-decoration-none reset-main-columns" type="button">Сбросить</button>
        </div>
      </div>
    </div>
  </div>

  {% if category_tables %}
    <div class="d-flex flex-column gap-4">
      {% for category_table in category_tables %}
        <div class="table-responsive card p-3 shadow-sm overflow-visible">
          <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <h2 class="h5 mb-0">
              {{ category_table.category.name|default:"" }}
            </h2>
            <span class="badge text-bg-light">
              {{ category_table.table.rows|length }}
            </span>
          </div>
          {% render_table category_table.table %}
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info mb-0">
      Товары не найдены.
    </div>
  {% endif %}
</div>

<style>
  .main-columns-menu {
    min-width: 240px;
  }
</style>
<script>
  (function () {
    const storageKey = 'main-price-columns';
    const toggles = document.querySelectorAll('.main-column-toggle');
    const resetBtn = document.querySelector('.reset-main-columns');

    const applyVisibility = (column, visible) => {
      document.querySelectorAll(`[data-col="${column}"]`).forEach((cell) => {
        cell.classList.toggle('d-none', !visible);
      });
    };

    const loadState = () => {
      try {
        const raw = localStorage.getItem(storageKey);
        return raw ? JSON.parse(raw) : null;
      } catch (err) {
        return null;
      }
    };

    const saveState = (state) => {
      localStorage.setItem(storageKey, JSON.stringify(state));
    };

    const state = loadState();
    if (state) {
      toggles.forEach((toggle) => {
        if (Object.prototype.hasOwnProperty.call(state, toggle.value)) {
          toggle.checked = state[toggle.value];
          applyVisibility(toggle.value, toggle.checked);
        }
      });
    }

    toggles.forEach((toggle) => {
      toggle.addEventListener('change', () => {
        applyVisibility(toggle.value, toggle.checked);
        const nextState = loadState() || {};
        nextState[toggle.value] = toggle.checked;
        saveState(nextState);
      });
    });

    if (resetBtn) {
      resetBtn.addEventListener('click', () => {
        toggles.forEach((toggle) => {
          toggle.checked = true;
          applyVisibility(toggle.value, true);
        });
        localStorage.removeItem(storageKey);
      });
    }
  })();
</script>
