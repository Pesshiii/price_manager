{% extends 'base.html' %}

{% block title %}
–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
{% endblock %}

{% block style %}
  .hover-wrapper {
      position: relative;
      cursor: pointer;
    }
    .hover-card {
      position: absolute;
      top: 50%;            /* drop below the cell text  */
      left: 100%;
      z-index: 9;        /* above table borders       */
      display: none;
      width: 240px;
    }
    .hover-wrapper:hover .hover-card,
    .hover-wrapper:focus .hover-card {
      display: block;
    }

    .main-page-layout {
      padding-left: 260px;
    }

    .filter-panel {
      position: fixed;
      top: 96px;
      left: 32px;
      width: 320px;
      max-height: calc(100vh - 128px);
      overflow-y: auto;
      z-index: 1030;
    }

    .filter-panel form {
      padding-bottom: 1rem;
    }

    .filter-panel .form-group + .form-group {
      margin-top: 1rem;
    }

    .table-area {
      margin-top: 2rem;
    }

    @media (max-width: 991.98px) {
      .main-page-layout {
        padding-right: 0;
      }

      .filter-panel {
        position: static;
        width: 100%;
        max-height: none;
        margin-top: 1.5rem;
        right: auto;
      }

      .table-area {
        margin-top: 1.5rem;
      }
    }
{% endblock %}

{% block body %}
<div class="container-fluid main-page-layout">
  {% include 'main/includes/table.html' %}
</div>

<div class="filter-panel card shadow-sm">
  <div class="card-body">
    <h2 class="h4">–§–∏–ª—å—Ç—Ä—ã</h2>
    <form method="get" class="form" id="main-filter-form">
      {{ filter_form.media }}

      <div id="filters-update-sink" class="d-none"></div>

      <div class="form-group mt-3">
        <label for="{{ filter_form.search.id_for_label }}">{{ filter_form.search.label }}</label>
        {{ filter_form.search }}
      </div>

      <div class="form-group mt-3">
        <label for="{{ filter_form.anti_search.id_for_label }}">{{ filter_form.anti_search.label }}</label>
        {{ filter_form.anti_search }}
      </div>


      {% if filter_form.available %}
      <div class="form-group mt-3">
        <label for="{{ filter_form.available.id_for_label }}">{{ filter_form.available.label }}</label>
        {{ filter_form.available }}
      </div>
      {% endif %}
      
      {% include 'main/includes/filter_field.html' with field=filter_form.category container_id='category-filter-container' collapse_id='category-filter-collapse' is_category=True category_tree=category_tree selected_categories=selected_categories available_options=None collapsible=False %}
      
      {% include 'main/includes/filter_field.html' with field=filter_form.manufacturer container_id='manufacturer-filter-container' collapse_id='manufacturer-filter-collapse' available_options=available_manufacturers available_options_label='–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏' collapsible=False %}
      
      {% include 'main/includes/filter_field.html' with field=filter_form.supplier container_id='supplier-filter-container' collapse_id='supplier-filter-collapse' available_options=available_suppliers available_options_label='–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏' collapsible=False %}



      <div class="mt-4 d-flex gap-2">
          <button type="submit" class="btn btn-primary flex-grow-1">
            üîç –ò—Å–∫–∞—Ç—å
          </button>
          <a href="{% url 'main-product-sync'%}" class="btn btn-success">
            <i class="bi bi-recycle"></i> –û–±–Ω–æ–≤–∏—Ç—å
          </a>
      </div>
    </form>
  </div>
</div>
<div id="shopping-tab-modal-container"></div>
{% endblock %}

{% block script %}
<script>
  document.body.addEventListener('htmx:configRequest', (evt) => {
    evt.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
  });

  const enhanceSelect = (selector) => {
    const element = window.jQuery ? window.jQuery(selector) : null;
    if (element && element.length && element.select2) {
      element.select2({
        width: '100%',
        placeholder: element.data('placeholder') || '',
        allowClear: true,
        language: {
          noResults: () => '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ',
          searching: () => '–ü–æ–∏—Å–∫‚Ä¶'
        }
      });
    }
  };

  const initDynamicFilters = () => {
    enhanceSelect('#id_supplier');
    enhanceSelect('#id_manufacturer');
  };
  
  const setToggleButtonState = (button, isExpanded) => {
    const expandedText = button.getAttribute('data-expanded-text') || button.textContent;
    const collapsedText = button.getAttribute('data-collapsed-text') || button.textContent;
    button.textContent = isExpanded ? expandedText : collapsedText;
    button.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
  };

  const initFilterToggle = (button) => {
    if (!button || button.dataset.filterToggleInitialized === 'true') {
      return;
    }

    const targetSelector = button.getAttribute('data-bs-target');
    if (!targetSelector) {
      return;
    }

    const target = document.querySelector(targetSelector);
    if (!target) {
      return;
    }

    const updateState = () => {
      const isExpanded = target.classList.contains('show');
      setToggleButtonState(button, isExpanded);
    };

    target.addEventListener('shown.bs.collapse', () => setToggleButtonState(button, true));
    target.addEventListener('hidden.bs.collapse', () => setToggleButtonState(button, false));

    updateState();

    button.dataset.filterToggleInitialized = 'true';
  };

  const initFilterToggles = () => {
    const buttons = document.querySelectorAll('[data-filter-toggle="button"]');
    buttons.forEach(initFilterToggle);
  };

  const debounce = (fn, delay = 300) => {
    let timerId;
    return (...args) => {
      if (timerId) {
        clearTimeout(timerId);
      }
      timerId = window.setTimeout(() => {
        timerId = null;
        fn(...args);
      }, delay);
    };
  };

  const getFilterForm = () => document.getElementById('main-filter-form');

  const requestTableUpdate = () => {
    if (!window.htmx) {
      return;
    }

    const form = getFilterForm();
    if (!form) {
      return;
    }

    const params = new URLSearchParams(new FormData(form));
    params.delete('page');

    const queryString = params.toString();
    const tableUrl = '{{ table_update_url|escapejs }}';
    const separator = tableUrl.includes('?') ? '&' : '?';
    const url = queryString ? `${tableUrl}${separator}${queryString}` : tableUrl;

    window.htmx.ajax('GET', url, {
      target: '#main-table-container',
      swap: 'outerHTML',
    });

    const newLocation = queryString ? `${window.location.pathname}?${queryString}` : window.location.pathname;
    window.history.replaceState({}, '', newLocation);
  };

  const scheduleTableUpdate = debounce(requestTableUpdate, 500);

  const registerAutoUpdate = () => {
    const form = getFilterForm();
    if (!form || form.dataset.autoUpdateInitialized === 'true') {
      return;
    }

    form.addEventListener('input', (event) => {
      const target = event.target;
      if (!target) {
        return;
      }

      if (target.matches('input[type="text"], input[type="search"], textarea')) {
        scheduleTableUpdate();
      }
    });

    form.addEventListener('change', (event) => {
      const target = event.target;
      if (!target) {
        return;
      }

      if (target.matches('input, select, textarea')) {
        requestTableUpdate();
      }
    });

    form.dataset.autoUpdateInitialized = 'true';
  };

  document.addEventListener('DOMContentLoaded', () => {
    initDynamicFilters();
    initFilterToggles();
    registerAutoUpdate();
  });

  const shouldEnhance = (target) => {
    if (!target) {
      return false;
    }
    return ['supplier-filter-container', 'manufacturer-filter-container'].includes(target.id);
  };

  document.body.addEventListener('htmx:afterSwap', (event) => {
    if (event.target && event.target.id === 'filters-update-sink') {
      initDynamicFilters();
      initFilterToggles();
      registerAutoUpdate();
    }
  });

  document.body.addEventListener('htmx:oobAfterSwap', (event) => {
    if (shouldEnhance(event.detail && event.detail.target)) {
      initDynamicFilters();
    }
    initFilterToggles();
    registerAutoUpdate();
  });

  const getCsrfToken = () => {
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    return match ? decodeURIComponent(match[1]) : '';
  };

  const showTemporaryAlert = (message, type = 'success') => {
    let container = document.querySelector('.alert-container');
    if (!container) {
      container = document.createElement('div');
      container.className = 'alert-container m-5 position-fixed end-0 top-0 p-3';
      container.style.zIndex = '1055';
      document.body.appendChild(container);
    }

    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show d-flex align-items-center`;
    alert.setAttribute('role', 'alert');
    alert.innerHTML = `<div>${message}</div><button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>`;
    container.appendChild(alert);

    window.setTimeout(() => {
      try {
        bootstrap.Alert.getOrCreateInstance(alert).close();
      } catch (error) {
        alert.remove();
      }
    }, 4000);
  };

  document.addEventListener('click', async (event) => {
    const button = event.target.closest('.add-to-shopping-tab-btn');
    if (!button) {
      return;
    }

    event.preventDefault();

    const modalUrl = button.getAttribute('data-modal-url');
    if (!modalUrl) {
      return;
    }

    try {
      const response = await fetch(modalUrl, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
        },
      });

      if (!response.ok) {
        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–æ—Ä–∑–∏–Ω—ã');
      }

      const html = await response.text();
      const container = document.getElementById('shopping-tab-modal-container');
      if (container) {
        container.innerHTML = html;
      }
    } catch (error) {
      showTemporaryAlert(error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'danger');
    }
  });

  document.addEventListener('submit', async (event) => {
    const form = event.target;
    if (!(form instanceof HTMLFormElement) || form.id !== 'add-to-shopping-tab-form') {
      return;
    }

    event.preventDefault();

    const formData = new FormData(form);

    try {
      const response = await fetch(form.action, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCsrfToken(),
          'X-Requested-With': 'XMLHttpRequest',
        },
        body: formData,
      });

      const data = await response.json();

      if (response.ok && data.status === 'ok') {
        const modalElement = document.getElementById('add-to-shopping-tab-modal');
        if (modalElement) {
          const modalInstance = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
          modalInstance.hide();
        }
        showTemporaryAlert(data.message || '–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É', 'success');
      } else {
        const message = data && data.errors ? Object.values(data.errors).flat().join('\n') : '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
        showTemporaryAlert(message, 'danger');
      }
    } catch (error) {
      showTemporaryAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä', 'danger');
    }
  });
</script>
{% endblock %}
