<div class="modal-header">
  <h5 class="modal-title">Добавить «{{ product.name|truncatechars:60 }}»</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
</div>
<div class="modal-body">
  {% if tabs %}
    <p class="text-muted">Выберите корзину, в которую нужно добавить товар.</p>
    <div class="list-group">
      {% for tab in tabs %}
        <form method="post"
              hx-post="{% url 'shopping-tab-add-product' tab_pk=tab.pk product_id=product.pk %}"
              hx-target="#shopping-tab-selection-modal-content"
              hx-swap="innerHTML"
              class="list-group-item list-group-item-action">
          {% csrf_token %}
          <div class="d-flex flex-column gap-2">
            <div class="d-flex justify-content-between align-items-start gap-2">
              <div>
                <div class="fw-semibold">{{ tab.name }}</div>
                <div class="small text-muted">Товаров: {{ tab.product_count }}</div>
              </div>
              {% if tab.pk in existing_tab_ids %}
                <span class="badge bg-success-subtle text-success-emphasis">Есть связка</span>
              {% endif %}
            </div>
            {% if tab.products.all %}
              <div>
                <label class="form-label small mb-1">Связать с товаром корзины</label>
                <select name="alternate_product_id" class="form-select form-select-sm">
                  <option value="">Создать новый товар</option>
                  {% for alternate in tab.products.all %}
                    <option value="{{ alternate.pk }}" {% if alternate.main_product_id == product.pk %}selected{% endif %}>
                      {{ alternate.name }}{% if alternate.main_product %} ({{ alternate.main_product.name }}){% endif %}
                    </option>
                  {% endfor %}
                </select>
              </div>
            {% else %}
              <input type="hidden" name="alternate_product_id" value="">
              <div class="small text-muted">В корзине пока нет товаров. Будет создан новый товар.</div>
            {% endif %}
            <div class="d-flex justify-content-end">
              <button type="submit" class="btn btn-primary btn-sm">
                {% if tab.pk in existing_tab_ids %}
                  <i class="bi bi-arrow-repeat"></i> Обновить связь
                {% else %}
                  <i class="bi bi-cart-plus"></i> Добавить
                {% endif %}
              </button>
            </div>
          </div>
        </form>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center text-muted py-4">
      <i class="bi bi-basket fs-1 d-block mb-3"></i>
      <p class="mb-0">У вас еще нет корзин. Сначала создайте корзину.</p>
    </div>
  {% endif %}
</div>
<div class="modal-footer">
  <a href="{% url 'shopping-tab-list' %}" class="btn btn-outline-secondary">Управлять корзинами</a>
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
</div>
